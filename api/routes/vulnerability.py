from fastapi import APIRouter
from pydantic import BaseModel
from fastapi.responses import HTMLResponse
from ai_models.vulnerability_detector import SmartContractVulnerabilityDetector

router = APIRouter()
model = SmartContractVulnerabilityDetector()

class ContractRequest(BaseModel):
    code: str

@router.post("/analyze", response_class=HTMLResponse)
def analyze_contract(req: ContractRequest):
    result = model.predict(req.code)

    vulnerability_type = result.get("vulnerability_type", "None")
    risk_level = result.get("risk_level", "Low")
    reason = result.get("reason", "No critical security concern identified.")
    recommendation = result.get("recommendation", "No action required.")
    vulnerable_snippet = result.get("vulnerable_code", "// Vulnerable code could not be isolated.")
    diagram_url = result.get("risk_diagram", "")
    prevention_methods = result.get("prevention_methods", [])
    reference_links = result.get("reference_links", [])
    print("DIAGRAM URL:", diagram_url)
    report = f"""
    <h3>ğŸ§¾ Contract Summary</h3>
    <p>This analysis was generated using a Mistral-backed AI model trained to detect Solidity smart contract vulnerabilities, following OWASP and blockchain security best practices.</p>

    <hr style='border: 1px solid #dee2e6;' />

    <h3>ğŸš¨ Vulnerability Detected: <code>{vulnerability_type}</code></h3>
    <h4>ğŸ“Š Risk Level: <span style='color:red;'>{risk_level}</span></h4>

    <h4>ğŸ§  Why it's Dangerous</h4>
    <p>{reason}</p>

    <hr style='border: 1px solid #dee2e6;' />

    <h4>ğŸ” Vulnerable Code Snippet</h4>
    <div style="background-color:#f8f9fa; border-radius:6px; padding:12px; border:1px solid #ccc;">
        <code style="white-space: pre-wrap;">{vulnerable_snippet}</code>
    </div>

    <hr style='border: 1px solid #dee2e6;' />

    <h4>âœ… Recommended Remediation</h4>
    <p>{recommendation}</p>

    <hr style='border: 1px solid #dee2e6;' />

    <h4>ğŸ›¡ï¸ Prevention Strategies</h4>
    <ul>
        {''.join([f"<li>{item}</li>" for item in prevention_methods])}
    </ul>

    <hr style='border: 1px solid #dee2e6;' />

    <h4>ğŸ“Š Risk Impact Diagram</h4>
    <div style="overflow-x: auto; border: 1px solid #ccc; padding:10px;">
        {diagram_url}
    </div>




    <hr style='border: 1px solid #dee2e6;' />

    <h4>ğŸ“š Trusted Security References</h4>
    <ul>
        {''.join([f"<li><a href='{link}' target='_blank'>{link}</a></li>" for link in reference_links])}
    </ul>

    <hr style='border: 1px solid #dee2e6;' />

    <small><b>ğŸ” Note:</b> This is an AI-generated analysis. Always validate results with manual code review and tools like 
        <a href="https://github.com/crytic/slither" target="_blank">Slither</a>, 
        <a href="https://mythx.io/" target="_blank">MythX</a>, and 
        <a href="https://securify.chainsecurity.com/" target="_blank">Securify</a> before deploying to production.
    </small>
    """

    return report
